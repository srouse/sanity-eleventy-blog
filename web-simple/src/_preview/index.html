<html>
  <script src="../_js/nunjucks/browser/nunjucks.js"></script>
  <script type="module">
    import getRoutes from '../routes.js';
    import nunjucksUtils from '../utils/nunjucksUtils.js';
    // import getMetadata from '../dist/_data/metadata.js';

    async function run() {
      // build data passed to templates
      const data = {
        context: {
          type: 'browser'
        }
      };

      // init nunjucks
      nunjucksUtils( nunjucks.configure('../_templates/', { autoescape: true }), data );

      // init routes and build global data...
      const routes = await getRoutes(data);

      // find the page to make and nunjuck it.
      const params = new URLSearchParams(window.location.search);
      const route = params.get('route');
      data.context.route = route;
      const routeInfo = routes.routes[route];
      if (routeInfo) {
        if (routeInfo.data) {
          await routeInfo.data(data);
        }
        const result = nunjucks.render(routeInfo.template, data);
        writeHTML(result);
      }else{
        const result = nunjucks.render('error.njk', {error:`no route found for "${route}"`});
        writeHTML(result);
      }
    }

    function writeHTML(html) {
      var newHTML = document.open("text/html", "replace");
      newHTML.write(html);
      newHTML.close();
    }
    run();
  </script>
</html>